name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci

    - name: Build web project
      run: npm run build

    - name: Verify web build output
      run: |
        echo "Verifying web build output..."
        if [ -d "dist" ]; then
          ls -la dist
        else
          echo "ERROR: Web build output directory 'dist' not found!"
          exit 1
        fi

    - name: Install Capacitor dependencies
      run: npm install @capacitor/android@^8.0.1

    - name: Initialize Capacitor Android project if not exists
      run: |
        if [ ! -d "android/app" ]; then
          echo "Initializing Capacitor Android project..."
          npx cap add android
        else
          echo "Capacitor Android project already exists, skipping initialization."
        fi

    - name: Sync Capacitor Android
      run: |
        echo "Syncing Capacitor Android..."
        npx cap sync android
        echo "Sync completed!"

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Gradle cache
      uses: gradle/gradle-build-action@v2

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Check environment information
      run: |
        echo "=== Environment Information ==="
        node --version
        npm --version
        java -version
        ./android/gradlew --version
        echo "=== End Environment Information ==="

    - name: Build Debug APK
      id: build-debug
      run: |
        echo "Building Debug APK with detailed logs..."
        cd android
        if ! ./gradlew assembleDebug --stacktrace --info; then
          echo "Debug APK build failed! Check the logs above for details."
          exit 1
        fi
        echo "Debug APK build completed!"

    - name: Check build output directory structure
      run: |
        echo "Checking build directory structure..."
        if [ -d "android/app/build/" ]; then
          ls -la android/app/build/
          if [ -d "android/app/build/outputs/" ]; then
            ls -la android/app/build/outputs/
            if [ -d "android/app/build/outputs/apk/" ]; then
              ls -la android/app/build/outputs/apk/
              if [ -d "android/app/build/outputs/apk/debug/" ]; then
                ls -la android/app/build/outputs/apk/debug/
              else
                echo "Debug APK directory does not exist!"
              fi
              if [ -d "android/app/build/outputs/apk/release/" ]; then
                ls -la android/app/build/outputs/apk/release/
              else
                echo "Release APK directory does not exist!"
              fi
            else
              echo "APK output directory does not exist!"
            fi
          else
            echo "Outputs directory does not exist!"
          fi
        else
          echo "Build directory does not exist!"
        fi
        echo "Build directory structure check completed!"

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Build Release APK
      id: build-release
      run: |
        echo "Building Release APK with detailed logs..."
        cd android
        if ! ./gradlew assembleRelease --stacktrace --info; then
          echo "Release APK build failed! Check the logs above for details."
          exit 1
        fi
        echo "Release APK build completed!"

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30
