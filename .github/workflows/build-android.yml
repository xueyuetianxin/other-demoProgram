name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      run: npm ci

    - name: Build web project
      run: npm run build

    - name: Verify web build output
      run: |
        echo "Verifying web build output..."
        if [ -d "dist" ]; then
          ls -la dist
        else
          echo "ERROR: Web build output directory 'dist' not found!"
          exit 1
        fi

    - name: Install Capacitor dependencies
      run: npm install @capacitor/android@^8.0.1

    - name: Initialize Capacitor Android project if not exists
      run: |
        if [ ! -d "android/app" ]; then
          echo "Initializing Capacitor Android project..."
          npx cap add android
        else
          echo "Capacitor Android project already exists, skipping initialization."
        fi

    - name: Sync Capacitor Android
      run: |
        echo "Syncing Capacitor Android..."
        npx cap sync android
        echo "Sync completed!"

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Gradle cache
      uses: gradle/gradle-build-action@v2

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android SDK components
      run: |
        echo "=== Installing Android SDK components ==="
        yes | sdkmanager --install "platforms;android-34" "build-tools;34.0.0" "extras;google;m2repository" "extras;android;m2repository"
        echo "=== SDK components installed ==="

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Check environment information
      run: |
        echo "=== Environment Information ==="
        node --version
        npm --version
        java -version
        ./android/gradlew --version
        echo "=== Android SDK Components ==="
        sdkmanager --list_installed
        echo "=== Gradle Properties ==="
        cat android/gradle.properties
        echo "=== End Environment Information ==="

    - name: Check Android project structure
      run: |
        echo "=== Android Project Structure ==="
        ls -la android
        ls -la android/app/src
        ls -la android/capacitor-cordova-android-plugins 2>/dev/null || echo "capacitor-cordova-android-plugins directory not found"
        echo "=== End Project Structure ==="

    - name: Build Debug APK
      id: build-debug
      run: |
        echo "=== Building Debug APK with maximum verbosity ==="
        cd android
        # Run Gradle with maximum verbosity for debugging
        if ! ./gradlew assembleDebug --stacktrace --debug --no-daemon; then
          echo "=== Debug APK build failed! ==="
          echo "=== Checking for common build issues ==="
          # Check if capacitor-android module exists
          if [ ! -d "../node_modules/@capacitor/android/capacitor" ]; then
            echo "ERROR: capacitor-android module not found!"
          fi
          # Check if cordova plugins module exists  
          if [ ! -d "capacitor-cordova-android-plugins" ]; then
            echo "ERROR: capacitor-cordova-android-plugins directory not found!"
          fi
          exit 1
        fi
        echo "=== Debug APK build completed! ==="

    - name: Check build output directory structure
      run: |
        echo "Checking build directory structure..."
        if [ -d "android/app/build/" ]; then
          ls -la android/app/build/
          if [ -d "android/app/build/outputs/" ]; then
            ls -la android/app/build/outputs/
            if [ -d "android/app/build/outputs/apk/" ]; then
              ls -la android/app/build/outputs/apk/
              if [ -d "android/app/build/outputs/apk/debug/" ]; then
                ls -la android/app/build/outputs/apk/debug/
              else
                echo "Debug APK directory does not exist!"
              fi
              if [ -d "android/app/build/outputs/apk/release/" ]; then
                ls -la android/app/build/outputs/apk/release/
              else
                echo "Release APK directory does not exist!"
              fi
            else
              echo "APK output directory does not exist!"
            fi
          else
            echo "Outputs directory does not exist!"
          fi
        else
          echo "Build directory does not exist!"
        fi
        echo "Build directory structure check completed!"

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Build Release APK
      id: build-release
      run: |
        echo "=== Building Release APK with maximum verbosity ==="
        cd android
        # Run Gradle with maximum verbosity for debugging
        if ! ./gradlew assembleRelease --stacktrace --debug --no-daemon; then
          echo "=== Release APK build failed! ==="
          echo "=== Checking for common build issues ==="
          exit 1
        fi
        echo "=== Release APK build completed! ==="

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30
