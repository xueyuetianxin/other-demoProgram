name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      run: npm ci

    - name: Build web project
      run: npm run build

    - name: Check Capacitor dependencies
      run: |
        echo "Checking Capacitor dependencies..."
        if [ ! -d "node_modules/@capacitor/android/" ]; then
          echo "Installing Capacitor Android dependencies..."
          npm install @capacitor/android@^8.0.1
        else
          echo "Capacitor Android dependencies already exist, skipping installation."
        fi
        echo "Capacitor dependencies check completed!"

    - name: Initialize Capacitor Android project if not exists
      run: |
        if [ ! -d "android/app" ]; then
          echo "Initializing Capacitor Android project..."
          npx cap add android
        else
          echo "Capacitor Android project already exists, skipping initialization."
        fi

    - name: Sync Capacitor Android
      run: |
        echo "Syncing Capacitor Android..."
        npx cap sync android
        echo "Sync completed!"

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Gradle cache
      uses: gradle/gradle-build-action@v2

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Build Debug APK
      run: |
        echo "Building Debug APK with detailed logs..."
        cd android
        ./gradlew assembleDebug --stacktrace --debug 2>&1 | head -500
        echo "Debug APK build completed!"

    - name: Check build output directory structure
      run: |
        echo "Checking build directory structure..."
        if [ -d "android/app/build/" ]; then
          ls -la android/app/build/
          if [ -d "android/app/build/outputs/" ]; then
            ls -la android/app/build/outputs/
            if [ -d "android/app/build/outputs/apk/" ]; then
              ls -la android/app/build/outputs/apk/
              if [ -d "android/app/build/outputs/apk/debug/" ]; then
                ls -la android/app/build/outputs/apk/debug/
              else
                echo "Debug APK directory does not exist!"
              fi
              if [ -d "android/app/build/outputs/apk/release/" ]; then
                ls -la android/app/build/outputs/apk/release/
              else
                echo "Release APK directory does not exist!"
              fi
            else
              echo "APK output directory does not exist!"
            fi
          else
            echo "Outputs directory does not exist!"
          fi
        else
          echo "Build directory does not exist!"
        fi
        echo "Build directory structure check completed!"

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Build Release APK
      run: |
        echo "Building Release APK..."
        cd android
        ./gradlew assembleRelease --stacktrace
        echo "Release APK build completed!"

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: android/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30
