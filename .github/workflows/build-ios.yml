name: Build iOS IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      run: npm ci

    - name: Build web project
      run: npm run build

    - name: Verify web build output
      run: |
        echo "Verifying web build output..."
        if [ -d "dist" ]; then
          ls -la dist
        else
          echo "ERROR: Web build output directory 'dist' not found!"
          exit 1
        fi

    - name: Install Capacitor dependencies
      run: npm install @capacitor/ios@^8.0.1

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'



    - name: Initialize Capacitor iOS project if not exists
      run: |
        if [ ! -d "ios/App" ]; then
          echo "Initializing Capacitor iOS project..."
          npx cap add ios
        else
          echo "Capacitor iOS project already exists, skipping initialization."
        fi

    - name: Sync Capacitor iOS
      run: |
        echo "Syncing Capacitor iOS..."
        npx cap sync ios
        echo "Sync completed!"

    - name: Show project structure
      run: |
        cd ios/App
        ls -la
        ls -la App

    - name: Check Xcode scheme
      run: |
        cd ios/App
        xcodebuild -list -project App.xcodeproj

    - name: Clean build directory
      run: |
        cd ios/App
        rm -rf DerivedData
        mkdir -p DerivedData

    - name: Check environment information
      run: |
        echo "=== Environment Information ==="
        node --version
        npm --version
        xcodebuild -version
        echo "=== End Environment Information ==="

    - name: Build iOS App for Simulator
      id: build-simulator
      run: |
        echo "Building iOS App for Simulator..."
        cd ios/App
        if ! xcodebuild clean build \
          -project App.xcodeproj \
          -scheme App \
          -configuration Debug \
          -sdk iphonesimulator \
          -derivedDataPath DerivedData \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -verbose; then
          echo "Simulator build failed! Check the logs above for details."
          exit 1
        fi
        echo "Simulator build completed!"

    - name: Build iOS App for Device (Archive)
      id: build-archive
      run: |
        echo "Building iOS App for Device (Archive)..."
        cd ios/App
        if ! xcodebuild archive \
          -project App.xcodeproj \
          -scheme App \
          -configuration Release \
          -sdk iphoneos \
          -archivePath App.xcarchive \
          -destination 'generic/platform=iOS' \
          -allowProvisioningUpdates \
          -verbose; then
          echo "Archive build failed! Check the logs above for details."
          exit 1
        fi
        echo "Archive build completed!"

    - name: Export IPA from Archive
      id: export-ipa
      run: |
        echo "Exporting IPA from Archive..."
        cd ios/App
        mkdir -p ExportOptions
        cat > ExportOptions/exportOptions.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>teamID</key>
    <string>$(xcodebuild -showBuildSettings -project App.xcodeproj -scheme App | grep DEVELOPMENT_TEAM | cut -d= -f2 | xargs)</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>destination</key>
    <string>export</string>
</dict>
</plist>
EOF
        if ! xcodebuild -exportArchive \
          -archivePath App.xcarchive \
          -exportPath Output \
          -exportOptionsPlist ExportOptions/exportOptions.plist \
          -verbose; then
          echo "IPA export failed! Check the logs above for details."
          exit 1
        fi
        echo "IPA export completed!"

    - name: Verify build output
      run: |
        echo "Checking build output..."
        cd ios/App
        ls -la DerivedData/Build/Products/Debug-iphonesimulator/
        ls -la App.xcarchive
        ls -la Output

    - name: Upload IPA file
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: ios/App/Output/*.ipa
        retention-days: 30
